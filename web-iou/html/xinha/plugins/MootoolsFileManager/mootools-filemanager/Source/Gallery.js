/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
(function(){FileManager.Gallery=new Class({Extends:FileManager,initialize:function(b){this.offsets={y:-72};this.parent(b);var a=function(){this.galleryContainer.setStyles({opacity:0,display:"block"});var f=this.el.getSize(),g=this.el.getPosition();this.galleryContainer.setStyles({top:g.y+f.y-1,left:g.x+(f.x-this.galleryContainer.getWidth())/2,opacity:1});this.hideClone();this.wrapper.setStyle("display","none");if(this.howto){var e=this;(function(){if(e.howto&&e.howto.fade){e.howto.fade(0).get("tween").chain(function(){this.element.destroy();e.howto=null})}}).delay(2000)}};this.addEvents({scroll:a,show:(function(){a.apply(this);this.populate()}),hide:function(){this.gallery.empty();this.captions={};this.files=[];this.hideClone();this.wrapper.setStyle("display","none")},modify:function(f){var e=this.normalize(f.dir+"/"+f.name);var g=(this.gallery.getElements("li").filter(function(h){var i=h.retrieve("file");return e==this.normalize(i.dir+"/"+i.name)},this)||null)[0];if(g){this.erasePicture(e,g)}}});this.addMenuButton("serialize");this.galleryContainer=new Element("div",{"class":"filemanager-gallery"}).inject(this.container);this.gallery=new Element("ul").inject(this.galleryContainer);var d,c=this.removeClone.bind(this);this.input=new Element("input",{name:"imgCaption"}).addEvent("keyup",function(f){if(f.key=="enter"){c(f)}});this.wrapper=new Element("div",{"class":"filemanager-wrapper",tween:{duration:200},opacity:0,events:{mouseenter:function(){$clear(d)},mouseleave:function(f){d=(function(){c(f)}).delay(500)}}}).adopt(new Element("span",{text:this.language.gallery.text}),this.input,new Element("div",{"class":"img"}),new Element("button",{text:this.language.gallery.save}).addEvent("click",c)).inject(document.body);this.droppables.push(this.gallery);this.captions={};this.files=[];this.animation={};this.howto=new Element("div",{"class":"howto",text:this.language.gallery.drag}).inject(this.galleryContainer);this.switchButton()},onDragComplete:function(g,h){if(!h||h!=this.gallery){return false}var f;if($type(g)=="string"){var e=g.split("/");f={name:e.pop(),dir:e.join("/")}}else{g.setStyles({left:"",top:""});f=g.retrieve("file")}var c=this,d=this.normalize(f.dir+"/"+f.name);if(this.files.contains(d)){return true}this.files.push(d);var b=new Asset.image(this.options.assetBasePath+"destroy.png").set({"class":"filemanager-remove",title:this.language.gallery.remove,events:{click:this.removePicture}}).store("gallery",this);var a=new Element("li").store("file",f).adopt(b,new Asset.image(this.options.baseURL+d,{onload:function(){var i=this;a.setStyle("background","none").addEvent("click",function(j){if(j){j.stop()}var k=i.getCoordinates();k.left+=i.getStyle("paddingLeft").toInt();k.top+=i.getStyle("paddingTop").toInt();c.hideClone();c.animation={from:{width:75,height:56,left:k.left,top:k.top},to:{width:200,height:150,left:k.left-75,top:k.top+k.height-150}};c.hideClone();c.input.removeEvents("blur").addEvent("blur",function(){c.captions[d]=this.get("value")||""});a.set("opacity",0);c.clone=i.clone();c.clone.store("file",f).store("parent",a).addClass("filemanager-clone").setStyles(c.animation.from).set({morph:{link:"chain"},styles:{position:"absolute",zIndex:1100},events:{click:function(l){c.fireEvent("preview",[c.options.baseURL+d,c.captions[d],a])}}}).inject(document.body).morph(c.animation.to).get("morph").chain(function(){c.input.set("value",c.captions[d]||"");c.wrapper.setStyles({opacity:0,display:"block",left:c.animation.to.left-12,top:c.animation.to.top-53}).fade(1).get("tween").chain(function(){c.input.focus()})})})}})).inject(this.gallery);this.tips.attach(b.appearOn(a));this.switchButton();return true},removeClone:function(b){if(!this.clone||(b.relatedTarget&&([this.clone,this.wrapper].contains(b.relatedTarget)||this.wrapper.hasChild(b.relatedTarget)))){return}if(this.clone.get("morph").timer){return}var a=this.clone.retrieve("file");if(!a){return}this.captions[this.normalize(a.dir+"/"+a.name)]=this.input.get("value")||"";this.clone.morph(this.animation.from).get("morph").clearChain().chain((function(){this.clone.retrieve("parent").set("opacity",1);this.clone.destroy()}).bind(this));this.wrapper.fade(0).get("tween").chain(function(){this.element.setStyle("display","none")})},hideClone:function(){if(!this.clone){return}this.clone.get("morph").cancel();var a=this.clone.retrieve("parent");if(a){a.set("opacity",1)}this.clone.destroy();this.wrapper.setStyles({opacity:0,display:"none"})},removePicture:function(f){if(f){f.stop()}var b=this.retrieve("gallery"),a=this.getParent("li"),d=a.retrieve("file"),c=b.normalize(d.dir+"/"+d.name);b.erasePicture(c,a)},erasePicture:function(c,b){this.captions[c]="";this.files.erase(c);this.tips.hide();var a=this;b.set("tween",{duration:250}).removeEvents("click").fade(0).get("tween").chain(function(){this.element.destroy();a.switchButton()})},switchButton:function(){var a=!!this.gallery.getChildren().length;this.menu.getElement("button.filemanager-serialize").set("disabled",!a)[(a?"remove":"add")+"Class"]("disabled")},populate:function(a){Hash.each(a||{},function(b,c){this.captions[c]=b;this.onDragComplete(c,this.gallery)},this)},serialize:function(a){if(a){a.stop()}var b={};this.files.each(function(c){b[c]=this.captions[c]||""},this);this.hide();this.fireEvent("complete",[b])}})})();