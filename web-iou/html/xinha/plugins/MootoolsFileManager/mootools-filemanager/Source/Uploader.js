/* This compressed file is part of Xinha. For uncompressed sources, forum, and bug reports, go to xinha.org */
FileManager.implement({options:{resizeImages:true,upload:true,uploadAuthData:{}},hooks:{show:{upload:function(){this.startUpload()}},cleanup:{upload:function(){if(!this.options.upload||!this.upload){return}if(this.upload.uploader){this.upload.uploader.set("opacity",0).dispose()}}}},onDialogOpen:function(){if(this.swf&&this.swf.box){this.swf.box.setStyle("visibility","hidden")}},onDialogClose:function(){if(this.swf&&this.swf.box){this.swf.box.setStyle("visibility","visible")}},startUpload:function(){if(!this.options.upload||this.swf){return}var c=this;this.upload={button:this.addMenuButton("upload").inject(this.menu,"bottom").addEvents({click:function(){return false},mouseenter:function(){this.addClass("hover")},mouseleave:function(){this.removeClass("hover");this.blur()},mousedown:function(){this.focus()}}),list:new Element("ul",{"class":"filemanager-uploader-list"}),uploader:new Element("div",{opacity:0,"class":"filemanager-uploader-area"}).adopt(new Element("h2",{text:this.language.upload}),new Element("div",{"class":"filemanager-uploader"}))};this.upload.uploader.getElement("div").adopt(this.upload.list);this.closeIcon.appearOn(this.upload.button,0.8);if(this.options.resizeImages){var d=new Element("div",{"class":"checkbox"}),b=(function(){this.toggleClass("checkboxChecked")}).bind(d);b();this.upload.label=new Element("label").adopt(d,new Element("span",{text:this.language.resizeImages})).addEvent("click",b).inject(this.menu)}var a=new Class({Extends:Swiff.Uploader.File,initialize:function(f,e){this.parent(f,e);this.setOptions({url:c.options.url+(c.options.url.indexOf("?")==-1?"?":"&")+Hash.toQueryString($merge({},c.options.uploadAuthData,{event:"upload",directory:c.normalize(c.Directory),resize:c.options.resizeImages&&d.hasClass("checkboxChecked")?1:0}))})},render:function(){if(this.invalid){var h=c.language.uploader.unknown,g={name:this.name,size:Swiff.Uploader.formatUnit(this.size,"b")};if(c.language.uploader[this.validationError]){h=c.language.uploader[this.validationError]}if(this.validationError=="sizeLimitMin"){g.size_min=Swiff.Uploader.formatUnit(this.base.options.fileSizeMin,"b")}else{if(this.validationError=="sizeLimitMax"){g.size_max=Swiff.Uploader.formatUnit(this.base.options.fileSizeMax,"b")}}new Dialog(new Element("div",{html:h.substitute(g,/\\?\$\{([^{}]+)\}/g)}),{language:{confirm:c.language.ok},buttons:["confirm"]});return this}this.addEvents({open:this.onOpen,remove:this.onRemove,requeue:this.onRequeue,progress:this.onProgress,stop:this.onStop,complete:this.onComplete});this.ui={};this.ui.icon=new Asset.image(c.options.assetBasePath+"Icons/"+this.extension+".png",{onerror:function(){new Asset.image(c.options.assetBasePath+"Icons/default.png").replaces(this)}});this.ui.element=new Element("li",{"class":"file",id:"file-"+this.id});this.ui.title=new Element("span",{"class":"file-title",text:this.name});this.ui.size=new Element("span",{"class":"file-size",text:Swiff.Uploader.formatUnit(this.size,"b")});var f=this;this.ui.cancel=new Asset.image(c.options.assetBasePath+"cancel.png",{"class":"file-cancel",title:c.language.cancel}).addEvent("click",function(){f.remove();c.tips.hide();c.tips.detach(this)});c.tips.attach(this.ui.cancel);var e=new Element("img",{"class":"file-progress",src:c.options.assetBasePath+"bar.gif"});this.ui.element.adopt(this.ui.cancel,e,this.ui.icon,this.ui.title,this.ui.size).inject(c.upload.list).highlight();this.ui.progress=new Fx.ProgressBar(e).set(0);this.base.reposition();return this.parent()},onOpen:function(){this.ui.element.addClass("file-running")},onRemove:function(){this.ui=this.ui.element.destroy()},onProgress:function(){this.ui.progress.start(this.progress.percentLoaded)},onStop:function(){this.remove()},onComplete:function(){this.ui.progress=this.ui.progress.cancel().element.destroy();this.ui.cancel=this.ui.cancel.destroy();var e=JSON.decode(this.response.text);if(!e.status){new Dialog((""+e.error).substitute(c.language,/\\?\$\{([^{}]+)\}/g),{language:{confirm:c.language.ok},buttons:["confirm"]})}this.ui.element.set("tween",{duration:2000}).highlight(e.status?"#e6efc2":"#f0c2c2");(function(){this.ui.element.setStyle("overflow","hidden").morph({opacity:0,height:0}).get("morph").chain(function(){this.element.destroy();if(!c.upload.list.getElements("li").length){c.upload.uploader.fade(0).get("tween").chain(function(){c.fillInfo()})}})}).delay(5000,this)}});this.swf=new Swiff.Uploader({id:"SwiffFileManagerUpload",path:this.options.assetBasePath+"Swiff.Uploader.swf",queued:false,target:this.upload.button,allowDuplicates:true,instantStart:true,fileClass:a,fileSizeMax:25*1024*1024,zIndex:this.SwiffZIndex||9999,onSelectSuccess:function(){c.fillInfo();c.info.getElement("h2.filemanager-headline").setStyle("display","none");c.info.adopt(c.upload.uploader);c.upload.uploader.fade(1)},onComplete:function(){c.load(c.Directory,true)},onFail:function(e){$$(c.upload.button,c.upload.label).dispose();new Dialog(new Element("div",{html:c.language.flash[e]||c.language.flash.flash}),{language:{confirm:c.language.ok},buttons:["confirm"]})}})}});